name: CI+CD Compose AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKER_HUB_USERNAME }}/image_name
  COMPOSE_DIR: /home/ubuntu/___
  DOCKER_COMPOSE_FILE: docker-compose.yml
  SERVICE_NAME: service_name_from_docker_compose

jobs:

  ###########################################################################
  # Job 0: Detect Terraform changes (optional)
  ###########################################################################
  detect-changes:
    name: Detect Terraform Changes
    runs-on: ubuntu-latest
    outputs:
      terraform_changed: ${{ steps.filter.outputs.terraform }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            terraform:
              - 'terraform/**'

  ###########################################################################
  # Job 1: Terraform Backend (conditional)
  ###########################################################################
  terraform-backend:
    name: Configure Terraform Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.terraform_changed == 'true'
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      - name: Check S3 Backend Bucket
        run: |
          if aws s3 ls "s3://${{ secrets.AWS_S3_BUCKET }}" 2>&1 | grep -q 'NoSuchBucket'; then
            echo "CREATE_BACKEND=true" >> $GITHUB_ENV
          else
            echo "CREATE_BACKEND=false" >> $GITHUB_ENV
      - name: Terraform Init & Apply
        run: |
          terraform init
          terraform apply -auto-approve -var="create_backend=$CREATE_BACKEND"
        working-directory: terraform/terraform_backend

  ###########################################################################
  # Job 2: Terraform Resources (conditional)
  ###########################################################################
  terraform-resources:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.terraform_changed == 'true'
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      - name: Terraform Init & Apply
        run: |
          terraform init
          terraform plan
          terraform apply -auto-approve
        working-directory: terraform/terraform_resources
      - name: Get EC2 Public IP
        id: get-ec2-ip
        run: echo "ec2_ip=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT
        working-directory: terraform/terraform_resources

  ###########################################################################
  # Job 3: Build and Push Docker Image
  ###########################################################################
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Docker Hub Login
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build and Push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          context: ./
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.run_number }}

      - name: Image Digest
        run: echo ${{ steps.docker_build.outputs.digest }}

  ###########################################################################
  # Job 4: Deploy Docker-Compose Service to EC2
  ###########################################################################
  deploy:
    name: Deploy Service via Compose on EC2
    runs-on: ubuntu-latest
    needs:
      - build
      - terraform-resources
    if: always()
    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ needs.terraform-resources.outputs.ec2_ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ” Checking Docker installation..."
            if ! command -v docker &> /dev/null; then
              echo "ðŸ”§ Installing Docker..."
              sudo apt update -y
              sudo apt install docker.io -y
            else
              echo "Docker already installed"
            fi

            echo "ðŸ” Checking Docker Compose installation..."
            if ! command -v docker-compose &> /dev/null; then
              echo "ðŸ”§ Installing Docker Compose..."
              sudo apt install docker-compose-plugin -y
            else
              echo "Docker Compose already installed"
            fi

            cd ${{ env.COMPOSE_DIR }}

            echo "ðŸ“¥ Pulling latest image..."
            docker pull ${{ env.IMAGE_NAME }}:${{ github.run_number }}

            echo "ðŸ’¾ Backup docker-compose.yml"
            cp ${{ env.COMPOSE_DIR }}/${{ env.DOCKER_COMPOSE_FILE }} ${{ env.COMPOSE_DIR }}/${{ env.DOCKER_COMPOSE_FILE }}.bak

            echo "ðŸ”„ Updating service image in docker-compose.yml"
            sed -i "/^  ${{ env.SERVICE_NAME }}:/,/image:/ s|image: .*|image: ${{ env.IMAGE_NAME }}:${{ github.run_number }}|" ${{ env.DOCKER_COMPOSE_FILE }}

            echo "âœ… Validating docker-compose file"
            docker compose -f ${{ env.COMPOSE_DIR }}/${{ env.DOCKER_COMPOSE_FILE }} config

            echo "ðŸš€ Deploying ${{ env.SERVICE_NAME }}..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} up -d --no-deps --build ${{ env.SERVICE_NAME }}
            echo "âœ… Deployment finished."

            echo "ðŸ§¹ Cleaning up backup"
            rm -f ${{ env.COMPOSE_DIR }}/${{ env.DOCKER_COMPOSE_FILE }}.bak || true

  ###########################################################################
  # Job 5: Notify
  ###########################################################################
  #will work on this later